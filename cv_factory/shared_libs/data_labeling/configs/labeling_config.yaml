# =========================================================================
# === CV FACTORY MLOPS CONFIGURATION: DATA LABELING LAYER
# =========================================================================

# Master schema: LabelingProjectConfig (shared_libs/data_labeling/configs/labeler_config_schema.py)
# This file defines one or more labeling pipelines, each corresponding to a CV task.

# -------------------------------------------------------------------------
# GLOBAL PROJECT SETTINGS
# -------------------------------------------------------------------------
labeling_pipelines:
  # --- PIPELINE 1: CLASSIFICATION (MANUAL PARSING MODE) ---
  - task_type: classification
    # Annotation Mode: 'manual' (loads pre-labeled data)
    annotation_mode: manual

    # [Hardening] T·ª∑ l·ªá m·∫´u nh√£n ƒë∆∞·ª£c ki·ªÉm tra t√≠nh h·ª£p l·ªá ng·∫´u nhi√™n
    validation_ratio: 0.05

    # Cache Configuration: D·ªØ li·ªáu nh√£n ƒë√£ chu·∫©n h√≥a (Pydantic objects) ƒë∆∞·ª£c l∆∞u v√†o ƒë√¢y.
    cache_path: s3://cvf-feature-store/labels/classification_v1.parquet

    # Schema: ClassificationLabelerConfig
    params:
      # [REQUIRED] URI/Path t·ªõi file nh√£n th√¥ (CSV/DB/etc.)
      label_source_uri: s3://cvf-raw-labels/clf_master_sheet.csv

      # T√™n c·ªôt trong file nh√£n
      image_path_column: file_path_s3
      label_column: final_class_label

      # ƒê∆∞·ªùng d·∫´n t·ªõi file √°nh x·∫° class name -> ID (n·∫øu c√≥)
      class_map_path: /mnt/configs/class_map_clf.json

  # --- PIPELINE 2: DETECTION (SEMI-ANNOTATION MODE / HITL) ---
  - task_type: detection
    # Annotation Mode: 'semi' (uses model proposal + human refinement)
    annotation_mode: semi
    validation_ratio: 0.01

    # Schema: DetectionLabelerConfig
    params:
      # [REQUIRED] URI/Path t·ªõi file metadata ·∫£nh (ch·ªâ c·∫ßn path/ID) ho·∫∑c nh√£n th√¥ (COCO JSON)
      label_source_uri: s3://cvf-raw-labels/detection_metadata_pool.json

      # ƒê·ªãnh d·∫°ng nh√£n ƒë·∫ßu v√†o th√¥ (n·∫øu l√† manual parsing/loading)
      input_format: coco_json

      # Chu·∫©n h√≥a BBox (pixel -> [0, 1])
      normalize_bbox: true

      # --- AUTO ANNOTATION CONFIGURATION (Triggered by 'semi' mode) ---
      auto_annotation:
        # Lo·∫°i Annotator s·ª≠ d·ª•ng
        annotator_type: detection
        # ƒê∆∞·ªùng d·∫´n m√¥ h√¨nh Proposal (YOLO/FasterRCNN)
        model_path: mlflow://prod/yolov5_proposal_v3
        # [REQUIRED] Ng∆∞·ª°ng tin c·∫≠y t·ªëi thi·ªÉu ƒë·ªÉ ch·∫•p nh·∫≠n ƒë·ªÅ xu·∫•t
        min_confidence: 0.85

      # --- SEMI ANNOTATION CONFIGURATION (Triggered by 'semi' mode) ---
      semi_annotation:
        # [REQUIRED] Ph∆∞∆°ng ph√°p HITL/Active Learning
        method_type: refinement

        # C·∫•u h√¨nh c·ª• th·ªÉ cho ph∆∞∆°ng ph√°p Refinement
        config:
          # [Hardening] Ng∆∞·ª°ng tin c·∫≠y cu·ªëi c√πng sau khi Refinement t·ª± ƒë·ªông (NMS/Filtering)
          final_threshold: 0.95
          # Logic NMS (Non-Maximum Suppression)
          nms_iou_threshold: 0.5

  # --- PIPELINE 3: OCR (AUTO ANNOTATION MODE) ---
  - task_type: ocr
    # Annotation Mode: 'auto' (ch·ªâ sinh nh√£n t·ª± ƒë·ªông, kh√¥ng c√≥ nh√£n th·ªß c√¥ng)
    annotation_mode: auto
    validation_ratio: 0.0

    # Schema: OCRLabelerConfig
    params:
      label_source_uri: s3://cvf-raw-labels/ocr_unlabeled_data.json

      # C·∫•u h√¨nh Tokenizer (cho convert_to_tensor)
      tokenizer_config:
        vocab_path: /mnt/configs/bert_tokenizer_vocab.txt
      max_sequence_length: 256
      padding_token: "[PAD]"

      # --- AUTO ANNOTATION CONFIGURATION (Triggered by 'auto' mode) ---
      auto_annotation:
        annotator_type: ocr
        model_path: mlflow://prod/easyocr_proposal_v1
        min_confidence: 0.90
        # Th∆∞ m·ª•c t·∫°m th·ªùi ƒë·ªÉ l∆∞u c√°c token BBox artifacts
        temp_artifact_dir: /tmp/ocr_bboxes_v1

  # --- PIPELINE 4: EMBEDDING (ACTIVE LEARNING MODE) ---
  - task_type: embedding
    # Annotation Mode: 'semi' (s·ª≠ d·ª•ng Active Learning ƒë·ªÉ ch·ªçn m·∫´u)
    annotation_mode: semi
    validation_ratio: 0.05

    # Schema: EmbeddingLabelerConfig
    params:
      label_source_uri: db://feature_store_metadata/embedding_pool
      vector_dim: 512

      # --- AUTO ANNOTATION CONFIGURATION (Model sinh Uncertainty Score) ---
      auto_annotation:
        annotator_type: embedding
        model_path: mlflow://prod/metric_embedding_v2
        min_confidence: 0.0 # B·ªè qua confidence, ch·ªâ c·∫ßn score

      # --- SEMI ANNOTATION CONFIGURATION (Active Learning Selector) ---
      semi_annotation:
        # [REQUIRED] Ph∆∞∆°ng ph√°p Active Learning
        method_type: active_learning

        config:
          # Ph∆∞∆°ng ph√°p l·∫•y m·∫´u c·ª• th·ªÉ
          method: uncertainty
          # S·ªë l∆∞·ª£ng m·∫´u c·∫ßn ch·ªçn cho v√≤ng g√°n nh√£n ti·∫øp theo
          selection_size: 500
          # Tr∆∞·ªùng trong metadata ch·ª©a score m√¥ h√¨nh (cho Uncertainty Sampling)
          score_key: uncertainty_score

  # üü¢ --- PIPELINE 5: SEGMENTATION (MANUAL PARSING MODE) --- üü¢
  - task_type: segmentation
    # Annotation Mode: 'manual' (ch√∫ng ta t·∫£i danh s√°ch ·∫£nh & mask files)
    annotation_mode: manual
    validation_ratio: 0.10 # T·ª∑ l·ªá ki·ªÉm tra cao h∆°n v√¨ mask ph·ª©c t·∫°p

    # Schema: SegmentationLabelerConfig
    params:
      # [REQUIRED] URI/Path t·ªõi file danh s√°ch (·∫£nh_path, mask_path, class_name)
      label_source_uri: s3://cvf-raw-labels/seg_master_sheet.csv

      # [REQUIRED] ƒê·ªãnh d·∫°ng encoding c·ªßa mask artifact
      mask_encoding: png_mask

      # C√°c c·ªôt c·∫ßn thi·∫øt cho SegmentationParser (gi·∫£ ƒë·ªãnh t·ªìn t·∫°i trong CSV)
      image_path_column: image_uri
      mask_path_column: mask_uri
      class_name_column: segmentation_class
