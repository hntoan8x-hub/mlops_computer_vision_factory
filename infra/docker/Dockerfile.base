# ----------------------------
# üîπ STAGE 1: C√†i ƒë·∫∑t dependencies (Build Stage)
# ----------------------------
FROM python:3.10 as dependency_builder

# C√†i ƒë·∫∑t c√°c c√¥ng c·ª• build C/C++ c·∫ßn thi·∫øt
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential gcc g++ git && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /build
# Gi·∫£ ƒë·ªãnh requirements/full.txt ch·ª©a T·∫§T C·∫¢ th∆∞ vi·ªán (Trainer/Inference/Monitor)
COPY requirements/full.txt .
RUN pip install --no-cache-dir -r full.txt


# ----------------------------
# üîπ STAGE 2: Base Runtime Image (K·∫ø th·ª´a cho c√°c Role)
# ----------------------------
FROM python:3.10-slim AS hardened_base

# 1Ô∏è‚É£ T·ªëi ∆∞u m√¥i tr∆∞·ªùng
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    LANG=C.UTF-8 \
    TZ=Asia/Ho_Chi_Minh

# 2Ô∏è‚É£ T·∫°o non-root user (Hardening)
RUN useradd -m appuser
WORKDIR /app
USER appuser

# 3Ô∏è‚É£ Copy code v√† libs chung (Ch·ªâ l√† CODE, kh√¥ng ph·∫£i Python packages)
COPY --chown=appuser:appuser shared_libs /app/shared_libs
COPY --chown=appuser:appuser configs /app/configs
COPY --chown=appuser:appuser scripts /app/scripts

# 4Ô∏è‚É£ Thi·∫øt l·∫≠p PATH (ƒë·ªÉ ch·∫°y script d·ªÖ d√†ng)
ENV PATH="/app/scripts:$PATH"
# Thi·∫øt l·∫≠p Python Path
ENV PYTHONPATH=/app:$PYTHONPATH

# Hardened Base Image: S·∫µn s√†ng cho c√°c Role Image k·∫ø th·ª´a